<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Login • Mod-ed-class</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #1a1b26; --bg-med: #24283b; --bg-light: #414868;
            --panel: #1f202e; --text: #c0caf5; --text-dark: #a9b1d6;
            --accent-primary: #bb9af7; --accent-secondary: #7aa2f7; --accent-red: #f7768e;
            --shadow: 0 10px 30px rgba(0,0,0,.4); --radius-lg: 16px; --radius-md: 12px;
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            margin: 0; background: var(--bg-dark); color: var(--text);
            display: grid; place-items: center; font-family: 'Poppins', sans-serif;
            -webkit-font-smoothing: antialiased; padding: 20px;
        }
        .login-container {
            display: flex; flex-direction: column; gap: 20px;
            width: 100%; max-width: 400px;
        }
        .title {
            font-size: 32px; font-weight: 700; color: var(--accent-primary);
            text-align: center; margin-bottom: 10px; display: flex;
            align-items: center; justify-content: center; gap: 12px;
        }
        .panel {
            background: var(--panel); border: 1px solid rgba(187, 154, 247, .1);
            border-radius: var(--radius-lg); box-shadow: var(--shadow);
            padding: 28px; transition: var(--transition);
        }
        .form { display: grid; gap: 16px; }
        .input-group { position: relative; }
        input {
            background: var(--bg-med); color: var(--text);
            border: 1px solid var(--bg-light); border-radius: var(--radius-md);
            padding: 12px 16px; outline: none; width: 100%;
            transition: var(--transition); font-size: 16px; font-family: inherit;
        }
        input:focus {
            border-color: var(--accent-secondary);
            box-shadow: 0 0 0 4px rgba(122, 162, 247, .25);
        }
        .btn {
            border: none; background: var(--bg-light); color: var(--text);
            padding: 12px 18px; border-radius: var(--radius-md); cursor: pointer;
            display: inline-flex; align-items: center; justify-content: center;
            transition: var(--transition); font-weight: 600; width: 100%; font-size: 16px;
        }
        .btn.primary {
            background: linear-gradient(135deg, var(--accent-primary), #9a7ecc);
            color: var(--bg-dark); font-weight: 700;
        }
        .btn:hover:not(:disabled) {
            filter: brightness(1.15); transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,.2);
        }
        .btn:disabled {
            background: var(--bg-med); color: var(--text-dark); cursor: not-allowed;
            transform: none; box-shadow: none;
        }
        #loginError {
            color: var(--accent-red); text-align: center; font-size: 14px;
            min-height: 20px; margin-top: 10px;
        }
        .tabs {
            display: flex; border-bottom: 1px solid var(--bg-light); margin-bottom: 24px;
        }
        .tab {
            flex: 1; padding: 12px; text-align: center; background: none; border: none;
            color: var(--text-dark); cursor: pointer; font-weight: 600;
            transition: var(--transition); border-bottom: 3px solid transparent; font-size: 15px;
        }
        .tab.active {
            color: var(--accent-primary); border-bottom-color: var(--accent-primary);
        }
    </style>
</head>
<body>

    <div class="login-container">
        <div class="title">
            <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" fill="currentColor" viewBox="0 0 256 256"><path d="M234.8,90.31a16,16,0,0,0-13-11.4l-56-8.14a4,4,0,0,1-3.26-2.22L138.65,14.7a16,16,0,0,0-29.3,0L85.47,68.55a4,4,0,0,1-3.26,2.22l-56,8.14a16,16,0,0,0-13,11.4,15.8,15.8,0,0,0,4.19,16.81l40.5,39.48a4,4,0,0,1,1.15,3.52l-9.57,55.8a16,16,0,0,0,23.23,16.81L116,203.2a4,4,0,0,1,3.74,0l49.8,26.17a16,16,0,0,0,23.23-16.81l-9.57-55.8a4,4,0,0,1,1.15-3.52L230.61,107.12A15.8,15.8,0,0,0,234.8,90.31Z"></path></svg>
            Mod-ed-class
        </div>
        <div class="panel">
            <div class="tabs">
                <button class="tab active" data-tab="teacher">Teacher / Admin</button>
                <button class="tab" data-tab="student">Student</button>
            </div>

            <form id="teacherLoginForm" class="form">
                <div class="input-group"><input type="text" id="schoolIdInput" placeholder="School ID" required value="pis" autocomplete="organization"></div>
                <div class="input-group"><input type="email" id="emailInput" placeholder="Email" required autocomplete="email"></div>
                <div class="input-group"><input type="password" id="passwordInput" placeholder="Password" required autocomplete="current-password"></div>
                <button type="submit" class="btn primary">Login</button>
            </form>

            <form id="studentLoginForm" class="form" style="display: none;">
                <div class="input-group"><input type="text" id="studentSchoolIdInput" placeholder="School ID" required value="pis" autocomplete="organization"></div>
                <div class="input-group"><input type="text" id="studentLoginIdInput" placeholder="Student Login ID" required autocomplete="username"></div>
                <div class="input-group"><input type="password" id="studentPasswordInput" placeholder="Password" required autocomplete="current-password"></div>
                <button type="submit" class="btn primary">Enter Class</button>
            </form>
            <div id="loginError"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        // ✅ FIX: Imported setPersistence and browserSessionPersistence
        import { getAuth, signInWithEmailAndPassword, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        const $ = sel => document.querySelector(sel);
        const firebaseConfig = { apiKey: "AIzaSyB5P-Ht1hi-KyvPKCbo9Ueu4d903hEOPOM", authDomain: "mod-ed-class.firebaseapp.com", databaseURL: "https://mod-ed-class-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "mod-ed-class", storageBucket: "mod-ed-class.appspot.com", messagingSenderId: "876182788592", appId: "1:876182788592:web:7b5cfe54b19aebe7486535" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                const isTeacher = tab.dataset.tab === 'teacher';
                $('#teacherLoginForm').style.display = isTeacher ? 'grid' : 'none';
                $('#studentLoginForm').style.display = isTeacher ? 'none' : 'grid';
                $('#loginError').textContent = '';
            });
        });
        
        const setLoadingState = (form, isLoading, message = '') => {
            const btn = form.querySelector('button[type="submit"]');
            const errorEl = $('#loginError');
            btn.disabled = isLoading;
            errorEl.textContent = message;
        };

        $('#teacherLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            setLoadingState(form, true, 'Logging in...');
            const schoolId = $('#schoolIdInput').value.trim();
            const email = $('#emailInput').value.trim();
            const password = $('#passwordInput').value.trim();

            if (!schoolId || !email || !password) {
                setLoadingState(form, false, 'All fields are required.');
                return;
            }

            try {
                // ✅ FIX: Set authentication persistence to the current session.
                // This ensures the login state is carried over to the teacher.html page.
                await setPersistence(auth, browserSessionPersistence);
                
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                const teacherRef = ref(db, `schools/${schoolId}/teachers/${user.uid}`);
                const snapshot = await get(teacherRef);

                if (snapshot.exists()) {
                    const teacherProfile = snapshot.val();
                    sessionStorage.setItem('schoolId', schoolId);
                    sessionStorage.setItem('userId', user.uid);
                    sessionStorage.setItem('userRole', teacherProfile.role);
                    window.location.href = teacherProfile.role === 'admin' ? './admin.html' : './teacher.html';
                } else {
                    setLoadingState(form, false, 'User profile not found for this school.');
                    auth.signOut();
                }
            } catch (error) {
                const friendlyMessage = error.message.replace('Firebase: ', '').replace(/(\(auth\/.*\))/, '').trim();
                setLoadingState(form, false, `Login failed: ${friendlyMessage}`);
            }
        });

        $('#studentLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            setLoadingState(form, true, 'Searching...');
            const schoolId = $('#studentSchoolIdInput').value.trim();
            const loginId = $('#studentLoginIdInput').value.trim();
            const password = $('#studentPasswordInput').value.trim();

            if (!schoolId || !loginId || !password) {
                setLoadingState(form, false, 'All fields are required.');
                return;
            }
            
            try {
                const studentsRef = ref(db, `schools/${schoolId}/students`);
                const snapshot = await get(studentsRef);

                if (!snapshot.exists()) {
                    setLoadingState(form, false, 'School ID not found.');
                    return;
                }

                const allStudents = snapshot.val();
                const [foundStudentId, foundStudent] = Object.entries(allStudents).find(
                    ([id, student]) => student.loginId === loginId && student.password === password
                ) || [];

                if (foundStudent) {
                    sessionStorage.setItem('schoolId', schoolId);
                    sessionStorage.setItem('studentId', foundStudentId);
                    window.location.href = './student.html';
                } else {
                    setLoadingState(form, false, 'Invalid Login ID or Password.');
                }
            } catch(error) {
                setLoadingState(form, false, 'An error occurred. Please try again.');
                console.error(error);
            }
        });
    </script>
</body>
</html>