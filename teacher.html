<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Teacher Portal • Mod-ed-class</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { 
        --bg-dark: #1a1b26; --bg-med: #24283b; --bg-light: #414868; 
        --panel: #1f202e; --text: #c0caf5; --text-dark: #a9b1d6; 
        --accent-primary: #bb9af7; --accent-secondary: #7aa2f7; 
        --accent-green: #9ece6a; --accent-yellow: #e0af68; --accent-red: #f7768e; 
        --shadow: 0 10px 30px rgba(0,0,0,.4); --radius-lg: 16px; 
        --radius-md: 12px; --radius-sm: 8px; 
        --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); 
    }
    body.light-theme {
        --bg-dark: #f0f2f5; --bg-med: #ffffff; --bg-light: #e4e6eb;
        --panel: #ffffff; --text: #050505; --text-dark: #65676b;
        --accent-primary: #8a3ffc; --accent-secondary: #0f62fe;
        --accent-green: #24a148; --accent-yellow: #ff832b; --accent-red: #da1e28;
        --shadow: 0 4px 12px rgba(0,0,0,.1);
    }
    * { box-sizing: border-box; } 
    body { margin: 0; background: var(--bg-dark); color: var(--text); -webkit-font-smoothing: antialiased; font-family: 'Poppins', sans-serif; transition: background-color .3s, color .3s; }
    .hidden { display: none !important; }
    .app-container { height: 100vh; display: flex; flex-direction: column; max-width: 1400px; margin: 0 auto; width: 100%; }
    .header { padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
    .title { font-size: 22px; font-weight: 700; color: var(--accent-primary); display: flex; align-items: center; gap: 10px;}
    .app { display: grid; grid-template-columns: 310px 1fr; gap: 20px; padding: 0 20px 20px; flex: 1; min-height: 0; } 
    .panel { background: var(--panel); border: 1px solid rgba(187, 154, 247, .1); border-radius: var(--radius-lg); box-shadow: var(--shadow); transition: var(--transition); }
    body.light-theme .panel { border-color: #e0e0e0; }
    .sidebar { padding: 20px; display: flex; flex-direction: column; gap: 18px; }
    .sidebar-section { display: flex; flex-direction: column; gap: 10px; flex: 1; min-height: 0; }
    .class-list { 
        flex: 1; overflow-y: auto; 
        display: grid; grid-template-columns: 1fr 1fr;
        gap: 10px; padding: 4px; 
    }
    .class-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-radius: var(--radius-md); background: var(--bg-med); border: 1px solid var(--bg-light); cursor: pointer; transition: var(--transition); flex-shrink: 0; }
    .class-item:hover { transform: translateY(-2px); border-color: var(--accent-secondary); }
    .class-item.active { border-color: var(--accent-primary); background: var(--bg-light); box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-primary) 30%, transparent); }
    .content.panel { display: flex; flex-direction: column; padding: 0; overflow: hidden; }
    .table-container { flex-grow: 1; overflow-y: auto; min-height: 0; }
    table { width: 100%; border-collapse: collapse; }
    thead th { text-align: left; padding: 12px 16px; background: var(--panel); position: sticky; top: 0; z-index: 1; border-bottom: 1px solid var(--bg-light); }
    thead th:first-child, tbody td:first-child { text-align: center; }
    input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent-primary); vertical-align: middle; }
    tbody tr { cursor: pointer; transition: background-color 0.2s; }
    tbody tr:hover { background-color: var(--bg-med); }
    tbody tr.selected { background-color: var(--bg-light); }
    tbody td { padding: 12px 16px; border-bottom: 1px solid var(--bg-med); vertical-align: middle; }
    .btn { border: none; background: var(--bg-light); color: var(--text); padding: 10px 16px; border-radius: var(--radius-md); cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: var(--transition); font-weight: 500; }
    .btn:hover:not(:disabled) { filter: brightness(1.2); transform: translateY(-1px); } 
    .btn:disabled { background: var(--bg-med); color: var(--text-dark); cursor: not-allowed; transform: none; box-shadow: none; filter: none;}
    .btn.primary { background: var(--accent-primary); color: #f0f0f0; } body.light-theme .btn.primary { color: #fff; }
    .btn.small { padding: 6px 10px; font-size: 13px; } 
    .btn.danger { background: var(--accent-red); color: #f0f0f0; } body.light-theme .btn.danger { color: #fff; }
    .power-remove-btn { padding: 5px 9px; font-size: 14px; background: var(--bg-med); border-radius: var(--radius-sm); transition: var(--transition); }
    .power-remove-btn:hover { background: var(--accent-red); color: #f0f0f0; transform: scale(1.1); }
    .pts { font-weight: 700; font-size: 18px; color: var(--accent-yellow); }
    .muted { color: var(--text-dark); }
    .placeholder { display: grid; place-items: center; height: 100%; text-align: center; padding: 20px;}
    .modal-backdrop { position: fixed; inset: 0; background: rgba(26, 27, 38, .8); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; pointer-events: none; transition: opacity .3s ease; }
    body.light-theme .modal-backdrop { background: rgba(0, 0, 0, .5); }
    .modal-backdrop.show { opacity: 1; pointer-events: auto; }
    .modal { width: min(720px, 96vw); background: var(--panel); border-radius: var(--radius-lg); transform: scale(.95); transition: transform .3s ease; display: flex; flex-direction: column; max-height: 90vh; }
    .modal-backdrop.show .modal { transform: scale(1); }
    .modal header { padding: 16px 24px; border-bottom: 1px solid var(--bg-light); font-size: 18px; font-weight: 700; display:flex; justify-content: space-between; align-items:center;}
    .modal .body { padding: 24px; overflow-y: auto; }
    .form-grid { display: grid; grid-template-columns: 80px 1fr 100px 50px; gap: 10px; align-items: center;}
    input, textarea, select { background: var(--bg-med); color: var(--text); border: 1px solid var(--bg-light); border-radius: var(--radius-md); padding: 10px; outline: none; transition: var(--transition); width: 100%; font-family: inherit;}
    textarea { min-height: 250px; resize: vertical; font-family: monospace; font-size: 14px; }
    .student-name-cell { display: flex; align-items: center; gap: 10px;}
    .power-icons { display: flex; gap: 6px; flex-wrap: wrap; }
    #bulkActionsPanel { padding: 12px 20px; display: flex; flex-wrap: wrap; align-items: center; gap: 12px; border-top: 1px solid var(--bg-light); flex-shrink: 0; }
    #bulkActionsPanel .form-group { display: flex; align-items:center; gap: 10px; }
    #bulkActionsPanel input { flex: 1; max-width: 120px; }
    #bulkActionsPanel .btn-group { display: flex; gap: 10px; }
    #bulkActionsPanel .btn-group .btn { flex: 1;}
    .content-header { padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--bg-light); }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--bg-light); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--accent-secondary); }

    @media (max-width: 900px) {
        .app { grid-template-columns: 1fr; }
        .header { flex-direction: column; gap: 12px; padding-bottom: 0; }
        .sidebar { padding-top: 0; }
        .sidebar-section { max-height: none; }
        .class-list { grid-template-columns: 1fr; }
        #bulkActionsPanel { flex-direction: column; align-items: stretch; }
        #bulkActionsPanel .form-group { width: 100%; }
        #bulkActionsPanel input { max-width: none; }
    }
  </style>
</head>
<body>
    <button id="themeToggleBtn" class="btn" style="position: fixed; top: 16px; right: 24px; z-index: 100; width: auto; height: auto; padding: 8px;">🌙</button>
    <div id="loader" class="placeholder">Verifying Access...</div>
    <div id="app" class="app-container hidden">
        <div class="header">
            <div class="title">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 256 256"><path d="M200,32H56A24,24,0,0,0,32,56V200a24,24,0,0,0,24,24H200a24,24,0,0,0,24-24V56A24,24,0,0,0,200,32Zm8,168a8,8,0,0,1-8,8H56a8,8,0,0,1-8-8V56a8,8,0,0,1,8-8H200a8,8,0,0,1,8,8ZM184,88a12,12,0,1,1-12-12A12,12,0,0,1,184,88Zm-56,0a12,12,0,1,1-12-12A12,12,0,0,1,128,88Zm-44,96a28,28,0,0,1,56,0,8,8,0,0,1-16,0,12,12,0,0,0-24,0,8,8,0,0,1-16,0Z"></path></svg>
                Teacher Portal
            </div>
            <div><span id="teacherEmail" class="muted" style="margin-right: 16px;"></span><button class="btn danger" id="btnLogout">Logout</button></div>
        </div>
        <div class="app">
            <aside class="sidebar panel">
                <div class="sidebar-section">
                    <h3 style="margin:0; padding-left: 4px;">Your Assigned Classes</h3>
                    <input type="text" id="classFilterInput" placeholder="Filter classes..." style="margin-top: 8px;">
                    <div class="class-list" id="classList"></div>
                </div>
                <div style="margin-top:auto; display:flex; flex-direction:column; gap: 12px; border-top: 1px solid var(--bg-light); padding-top: 18px;">
                    <button class="btn" id="btnBonusTask">🎯 Bonus Task</button>
                    <button class="btn" id="btnTogglePowers">🔮 Manage My Shop</button>
                    <button class="btn" id="btnToggleActions">⚡️ Manage Quick Actions</button>
                    <button class="btn" id="btnSettings">⚙️ Settings</button>
                </div>
            </aside>
            <section class="content panel">
                <div class="content-header">
                    <h3 id="classNameHeader" style="margin:0;">Select a class</h3>
                    <button class="btn danger hidden" id="btnStopBonusTask">🛑 Stop Current Bonus Task</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th style="width:5%"><input type="checkbox" id="selectAllCheckbox"></th>
                                <th style="width:50%">Student</th>
                                <th style="width:15%">EDcoins</th>
                                <th>Quick Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studentsBody"></tbody>
                    </table>
                </div>
                <div id="bulkActionsPanel" class="hidden">
                    <div id="bulkStatus" style="font-weight: 500; flex-shrink: 0; margin-right: auto;"></div>
                    <div class="form-group">
                        <input type="number" id="bulkAmountInput" placeholder="Amount" value="10">
                        <div class="btn-group">
                            <button class="btn" id="btnBulkAward" style="background-color: var(--accent-green); color: #f0f0f0">Award</button>
                            <button class="btn" id="btnBulkDeduct" style="background-color: var(--accent-red); color: #f0f0f0">Deduct</button>
                        </div>
                    </div>
                    <button class="btn" id="btnOpenShop" style="background-color: var(--accent-secondary); color: #f0f0f0; flex-shrink: 0;">🛒 Open Shop</button>
                </div>
            </section>
        </div>
    </div>
    <div class="modal-backdrop" id="manageModal"><div class="modal"><header><span id="manageModalTitle">Manage</span> <button class="btn small danger" data-action="close-modal">✖</button></header><div class="body" id="manageModalBody"></div></div></div>
    <div class="modal-backdrop" id="messageModal"><div class="modal"><header id="messageTitle">Notification</header><div class="body" style="text-align:center;"><p id="messageText"></p><button class="btn primary" data-action="close-modal">OK</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, updatePassword, EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getDatabase, ref, onValue, update, set, remove } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        const $ = sel => document.querySelector(sel);
        const firebaseConfig = { apiKey: "AIzaSyB5P-Ht1hi-KyvPKCbo9Ueu4d903hEOPOM", authDomain: "mod-ed-class.firebaseapp.com", databaseURL: "https://mod-ed-class-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "mod-ed-class", storageBucket: "mod-ed-class.appspot.com", messagingSenderId: "876182788592", appId: "1:876182788592:web:7b5cfe54b19aebe7486535" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        let schoolData = {}, teacherProfile = {}, activeClassId = null, selectedStudentIds = [];
        
        const showMessage = (text, title = "Notification") => { $('#messageText').textContent = text; $('#messageTitle').textContent = title; $('#messageModal').classList.add('show'); };
        const closeModal = () => document.querySelectorAll('.modal-backdrop.show').forEach(m => m.classList.remove('show'));

        const schoolId = sessionStorage.getItem('schoolId');
        const teacherId = sessionStorage.getItem('userId');

        // --- THEME TOGGLE ---
        const themeToggleBtn = $('#themeToggleBtn');
        const applyTheme = (theme) => {
            if (theme === 'light') {
                document.body.classList.add('light-theme');
                themeToggleBtn.textContent = '☀️';
            } else {
                document.body.classList.remove('light-theme');
                themeToggleBtn.textContent = '🌙';
            }
        };
        const currentTheme = localStorage.getItem('theme') || 'dark';
        applyTheme(currentTheme);
        themeToggleBtn.addEventListener('click', () => {
            const newTheme = document.body.classList.contains('light-theme') ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });
        // --- END THEME TOGGLE ---

        if (!schoolId || !teacherId) {
            $('#loader').textContent = 'Access Denied. Redirecting...';
            setTimeout(() => { window.location.href = './index.html'; }, 1500);
        } else {
            onAuthStateChanged(auth, user => {
                if (user && user.uid === teacherId) {
                    initializeTeacherPortal(user, schoolId, teacherId);
                } else {
                    $('#loader').textContent = 'Session expired. Redirecting...';
                    setTimeout(() => { window.location.href = './index.html'; }, 1500);
                }
            });
        }

        function initializeTeacherPortal(user, schoolId, teacherId) {
            $('#loader').classList.add('hidden'); 
            $('#app').classList.remove('hidden'); 
            $('#teacherEmail').textContent = user.email;

            onValue(ref(db, `schools/${schoolId}`), (snapshot) => {
                if (!snapshot.exists()) { console.error("School data not found!"); return; }
                schoolData = snapshot.val();
                teacherProfile = schoolData.teachers?.[teacherId] || {};
                const assignedClasses = Object.keys(teacherProfile.assignedClasses || {});
                if (!activeClassId || !assignedClasses.includes(activeClassId)) {
                    activeClassId = assignedClasses[0] || null;
                    selectedStudentIds = [];
                }
                renderAll();
            });
            
            setInterval(renderContentHeader, 30000);
        }
        
        function renderAll() { renderClasses(); renderStudents(); renderBulkActionsPanel(); renderContentHeader(); }

        function renderClasses() {
            const assignedIds = Object.keys(teacherProfile.assignedClasses || {});
            const filterText = $('#classFilterInput').value.toLowerCase().trim();

            const filteredClassIds = assignedIds.filter(id => {
                const className = schoolData.classes?.[id]?.name || '';
                return className.toLowerCase().includes(filterText);
            });

            $('#classList').innerHTML = filteredClassIds.length === 0 ? `<p class="muted" style="padding: 1rem; grid-column: 1 / -1;">No matching classes found.</p>` :
                filteredClassIds.map(id => `<div class="class-item ${id === activeClassId ? 'active' : ''}" data-id="${id}"><span>${schoolData.classes?.[id]?.name || 'Unknown Class'}</span></div>`).join('');
        }
        
        function renderContentHeader() {
            if (!activeClassId) {
                $('#classNameHeader').textContent = 'Select a class';
                $('#btnStopBonusTask').classList.add('hidden');
                $('#btnBonusTask').disabled = true;
                return;
            }
            $('#classNameHeader').textContent = schoolData.classes[activeClassId].name;
            $('#btnBonusTask').disabled = false;
            
            const bonusTask = schoolData.bonusTasks?.[activeClassId];
            const isExpired = bonusTask && bonusTask.expiresAt && new Date(bonusTask.expiresAt) < new Date();
            const canStopTask = bonusTask && bonusTask.teacherId === teacherId && !isExpired;
            $('#btnStopBonusTask').classList.toggle('hidden', !canStopTask);
        }

        function renderStudents() {
            const body = $('#studentsBody');
            if (!activeClassId) { body.innerHTML = `<tr><td colspan="4" class="placeholder"><h3>👋 Welcome!</h3><p class="muted">Select a class from the sidebar to begin.</p></td></tr>`; return; }
            
            const studentsInClass = Object.entries(schoolData.students || {}).filter(([_, stu]) => stu.classId === activeClassId);
            if (studentsInClass.length === 0) { body.innerHTML = `<tr><td colspan="4" class="placeholder"><h4>This class is empty</h4><p class="muted">The admin can add students.</p></td></tr>`; return; }
            
            const quickActions = teacherProfile.settings?.quickActions || [];

            body.innerHTML = studentsInClass.map(([id, stu]) => {
                const isSelected = selectedStudentIds.includes(id);
                const powerIcons = (stu.powers || [])
                    .map((pInstance, index) => ({ ...pInstance, originalIndex: index })) 
                    .filter(pInstance => pInstance.teacherId === teacherId) 
                    .map(pInstance => {
                        const powerInfo = teacherProfile.settings?.powers?.find(p => p.id === pInstance.powerId);
                        return powerInfo ? `<button class="btn power-remove-btn" title="Remove '${powerInfo.name}'" data-action="remove-power" data-student-id="${id}" data-power-index="${pInstance.originalIndex}">${powerInfo.emoji}</button>` : '';
                    }).join('');
                
                const actionButtons = quickActions.map(action => `<button class="btn small ${action.delta < 0 ? 'danger' : ''}" data-action="quick-action" data-val="${action.delta}" data-id="${id}">${action.label}</button>`).join('');

                return `
                <tr class="${isSelected ? 'selected' : ''}" data-id="${id}">
                    <td><input type="checkbox" data-id="${id}" ${isSelected ? 'checked' : ''}></td>
                    <td><div class="student-name-cell">${stu.name}<div class="power-icons">${powerIcons}</div></div></td>
                    <td class="pts">${stu.edcoins || 0}</td>
                    <td><div style="display: flex; gap: 6px; flex-wrap: wrap;">${actionButtons}</div></td>
                </tr>`;
            }).join('');
            
            const allInViewIds = studentsInClass.map(([id]) => id);
            $('#selectAllCheckbox').checked = allInViewIds.length > 0 && allInViewIds.every(id => selectedStudentIds.includes(id));
        }

        function renderBulkActionsPanel() {
            const panel = $('#bulkActionsPanel');
            if (selectedStudentIds.length > 0) {
                panel.classList.remove('hidden');
                $('#bulkStatus').textContent = `${selectedStudentIds.length} student(s) selected.`;
            } else {
                panel.classList.add('hidden');
            }
        }
        
        function updateStudentCoins(studentIds, amount) {
            if (!Array.isArray(studentIds) || studentIds.length === 0 || isNaN(amount)) return;
            const updates = {};
            studentIds.forEach(id => {
                const currentCoins = schoolData.students[id]?.edcoins || 0;
                updates[`/students/${id}/edcoins`] = Math.max(0, currentCoins + amount);
            });
            update(ref(db, `schools/${schoolId}`), updates).catch(err => showMessage(`Coin update failed: ${err.message}`, 'Error'));
        }
        
        const showBonusTaskModal = () => {
            const modal = $('#manageModal'), title = $('#manageModalTitle'), body = $('#manageModalBody');
            title.textContent = '🎯 Create Bonus Task';
            
            const instructions = `<p class="muted" style="margin-top:0; text-align:left;">
                Paste questions below. Each question must start with '?', and the first answer on the next line is the correct one.
                <br>Example:<br>
                <code>? What is the capital of Tajikistan?</code><br>
                <code>Dushanbe</code><br>
                <code>Khujand</code><br>
                <code>Bokhtar</code>
            </p>`;

            const content = `${instructions}
                <textarea id="questionsImport" placeholder="Paste your questions here..."></textarea>
                <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div><label>Optional: Task expires on</label><input type="datetime-local" id="taskExpiryDate"></div>
                </div>
                <div style="margin-top:20px; display:flex; gap:10px; justify-content:flex-end;">
                    <button class="btn primary" id="btnStartTask">Start Task</button>
                </div>`;
            
            body.innerHTML = content;
            modal.classList.add('show');
        };

        const showGtTrainingModal = () => {
            const modal = $('#manageModal'), title = $('#manageModalTitle'), body = $('#manageModalBody');
            title.textContent = '✍️ GT Training Bank';
            
            const instructions = `<p class="muted" style="margin-top:0; text-align:left;">
                Upload a bank of up to 100 questions for student practice. The subject will be based on your profile's subject setting.
                <br>Each question must start with '?', and the first answer on the next line is the correct one.
            </p>`;

            const currentBank = schoolData.gtTraining?.[teacherId];
            const existingQuestions = currentBank?.questions?.map(q => {
                const answers = q.answers.map(a => a.text).join('\n');
                return `? ${q.question}\n${answers}`;
            }).join('\n\n') || '';

            const content = `${instructions}
                <textarea id="gtQuestionsImport" placeholder="Paste your questions here...">${existingQuestions}</textarea>
                <div style="margin-top:20px; display:flex; gap:10px; justify-content:flex-end;">
                    <button class="btn primary" id="btnSaveGtBank">Save Question Bank</button>
                </div>`;
            
            body.innerHTML = content;
            modal.classList.add('show');
        };

        const showManageModal = (type) => {
            const modal = $('#manageModal'), title = $('#manageModalTitle'), body = $('#manageModalBody');
            let content = '';
            if (type === 'powers') {
                title.textContent = '🔮 Manage My Shop';
                const powers = teacherProfile.settings?.powers || [];
                const powerRows = powers.map(p => `
                    <div class="power-item-editor">
                        <div class="form-grid" data-item-type="powers" data-id="${p.id}" style="margin-bottom: 8px;">
                            <input type="text" placeholder="🔮" value="${p.emoji || ''}" data-field="emoji" style="text-align:center; font-size: 18px;">
                            <input type="text" placeholder="Power Name" value="${p.name || ''}" data-field="name">
                            <input type="number" placeholder="Cost" value="${p.cost || 0}" data-field="cost">
                            <button class="btn small danger" data-remove="item">✖</button>
                        </div>
                        <textarea placeholder="Item description..." data-field="description" style="min-height: 60px; font-size: 13px; resize: none;">${p.description || ''}</textarea>
                    </div>
                `).join('');
                content = `<p class="muted" style="margin-top:0;">Add, edit, or remove items available for purchase with EDcoins.</p><div id="powersList" style="display:flex; flex-direction:column; gap:16px;">${powerRows}</div><div style="margin-top:20px; display:flex; gap:10px; justify-content:flex-end;"><button class="btn" id="btnAddPower">Add Item</button><button class="btn primary" id="btnSaveChanges" data-type="powers">Save Changes</button></div>`;
            } else if (type === 'quickActions') {
                title.textContent = '⚡️ Manage Quick Actions';
                const actions = teacherProfile.settings?.quickActions || [];
                const actionRows = actions.map(a => `<div class="form-grid" data-item-type="quickActions" style="grid-template-columns: 1fr 1fr 50px;"><input type="text" placeholder="Label (e.g., Good work)" value="${a.label || ''}" data-field="label"><input type="number" placeholder="Amount (e.g., 10 or -5)" value="${a.delta || 0}" data-field="delta"><button class="btn small danger" data-remove="item">✖</button></div>`).join('');
                content = `<p class="muted" style="margin-top:0;">Customize buttons for quick point awards/deductions.</p><div id="actionsList" style="display:flex; flex-direction:column; gap:10px;">${actionRows}</div><div style="margin-top:20px; display:flex; gap:10px; justify-content:flex-end;"><button class="btn" id="btnQuickAction">Add Action</button><button class="btn primary" id="btnSaveChanges" data-type="quickActions">Save Changes</button></div>`;
            }
            body.innerHTML = content;
            modal.classList.add('show');
        };

        const showPurchaseModal = () => {
            const powers = teacherProfile.settings?.powers || [];
            if (powers.length === 0) { showMessage("Your shop is empty. Add items in 'Manage My Shop' first.", "Shop Empty"); return; }
            const powerButtons = powers.map(p => `<button class="btn" data-purchase-power-id="${p.id}" style="flex-direction: column; height: auto; text-align: center; padding: 16px;"><span style="font-size: 24px; pointer-events: none;">${p.emoji || '✨'}</span><span style="font-weight: 600; pointer-events: none;">${p.name}</span><span style="font-size: 14px; color: var(--accent-yellow); pointer-events: none;">${p.cost} EDcoins</span></button>`).join('');
            const body = `<p class="muted" style="margin-top: 0;">Select an item to purchase for the ${selectedStudentIds.length} selected student(s).</p><div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px;">${powerButtons}</div>`;
            $('#manageModalTitle').textContent = `🛒 Purchase for ${selectedStudentIds.length} Student(s)`;
            $('#manageModalBody').innerHTML = body;
            $('#manageModal').classList.add('show');
        };
        
        const showSettingsModal = () => {
            const modal = $('#manageModal'), title = $('#manageModalTitle'), body = $('#manageModalBody');
            title.textContent = '⚙️ Settings';
            body.innerHTML = `<div style="display:flex; flex-direction:column; gap:16px; align-items: flex-start;">
                    <p class="muted" style="margin-top:0; text-align: left; width: 100%;">Manage your account and question banks.</p>
                    <button class="btn" data-action="show-change-password">🔑 Change Password</button>
                    <button class="btn" data-action="show-gt-training">✍️ Manage GT Training Bank</button>
                </div>`;
            modal.classList.add('show');
        };
        
        const showChangePasswordModal = () => {
            const modal = $('#manageModal'), title = $('#manageModalTitle'), body = $('#manageModalBody');
            title.textContent = '🔑 Change Password';
            body.innerHTML = `
                <div style="display:flex; flex-direction:column; gap:16px;">
                    <div>
                        <label>Current Password</label>
                        <input type="password" id="currentPasswordInput" required style="margin-top:4px;">
                    </div>
                    <div>
                        <label>New Password</label>
                        <input type="password" id="newPasswordInput" style="margin-top:4px;">
                    </div>
                    <div>
                        <label>Confirm New Password</label>
                        <input type="password" id="confirmPasswordInput" style="margin-top:4px;">
                    </div>
                </div>
                <div style="margin-top:20px; display:flex; gap:10px; justify-content:flex-end;">
                    <button class="btn primary" id="btnSaveChangesPassword">Save New Password</button>
                </div>
            `;
            modal.classList.add('show');
        };

        // --- Event Listeners ---
        $('#btnLogout').addEventListener('click', () => signOut(auth).then(() => { sessionStorage.clear(); window.location.href = './index.html'; }));
        
        $('#classFilterInput').addEventListener('input', renderClasses);

        $('#classList').addEventListener('click', e => {
            const item = e.target.closest('.class-item');
            if (item && item.dataset.id !== activeClassId) { 
                activeClassId = item.dataset.id; 
                selectedStudentIds = []; 
                renderAll(); 
            }
        });
        
        $('#studentsBody').addEventListener('click', e => {
            const target = e.target;
            const row = target.closest('tr[data-id]');
            if (!row) return;

            const actionBtn = target.closest('[data-action]');
            if (actionBtn) {
                e.stopPropagation();
                const { action, studentId, powerIndex, val, id } = actionBtn.dataset;
                if (action === 'remove-power') {
                    const student = schoolData.students[studentId];
                    const powerInstance = student?.powers?.[powerIndex];
                    if (student && powerInstance) {
                        const powerInfo = teacherProfile.settings?.powers?.find(p => p.id === powerInstance.powerId);
                        if (confirm(`Remove "${powerInfo?.name || 'this power'}" from ${student.name}?`)) {
                            const updatedPowers = [...(student.powers || [])]; updatedPowers.splice(powerIndex, 1);
                            update(ref(db, `schools/${schoolId}/students/${studentId}`), { powers: updatedPowers.length > 0 ? updatedPowers : null });
                        }
                    }
                } else if (action === 'quick-action') { updateStudentCoins([id], parseInt(val)); }
                return;
            }

            if (!target.matches('input[type="checkbox"]')) { selectedStudentIds = [row.dataset.id]; renderAll(); }
        });

        $('#studentsBody').addEventListener('change', e => {
            if (e.target.matches('input[type="checkbox"]')) {
                const studentId = e.target.dataset.id;
                const index = selectedStudentIds.indexOf(studentId);
                if (e.target.checked) { if (index === -1) selectedStudentIds.push(studentId); } 
                else { if (index > -1) selectedStudentIds.splice(index, 1); }
                renderAll();
            }
        });

        $('#selectAllCheckbox').addEventListener('change', e => {
            const allStudentIds = [...document.querySelectorAll('#studentsBody tr[data-id]')].map(tr => tr.dataset.id);
            selectedStudentIds = e.target.checked ? allStudentIds : [];
            renderAll();
        });
        
        $('#btnBulkAward').addEventListener('click', () => updateStudentCoins(selectedStudentIds, Math.abs(parseInt($('#bulkAmountInput').value))));
        $('#btnBulkDeduct').addEventListener('click', () => updateStudentCoins(selectedStudentIds, -Math.abs(parseInt($('#bulkAmountInput').value))));
        $('#btnTogglePowers').addEventListener('click', () => showManageModal('powers'));
        $('#btnToggleActions').addEventListener('click', () => showManageModal('quickActions'));
        $('#btnOpenShop').addEventListener('click', () => showPurchaseModal());
        $('#btnBonusTask').addEventListener('click', () => showBonusTaskModal());
        $('#btnSettings').addEventListener('click', showSettingsModal);
        $('#btnStopBonusTask').addEventListener('click', () => {
            if (confirm('Are you sure you want to stop the current bonus task for this class?')) {
                remove(ref(db, `schools/${schoolId}/bonusTasks/${activeClassId}`));
            }
        });

        document.addEventListener('click', e => {
            const target = e.target;
            const actionTarget = target.closest('[data-action]');
            if (actionTarget) {
                const action = actionTarget.dataset.action;
                if (action === 'close-modal') closeModal();
                if (action === 'show-change-password') showChangePasswordModal();
                if (action === 'show-gt-training') showGtTrainingModal();
                return;
            }

            if (target.id === 'btnStartTask') {
                const text = $('#questionsImport').value.trim();
                const expiry = $('#taskExpiryDate').value;
                const lines = text.split('\n').filter(line => line.trim() !== '');
                
                if (lines.length === 0) { return showMessage('Please enter at least one question.', 'Error'); }

                const questions = [];
                let currentQuestion = null;

                lines.forEach(line => {
                    const trimmedLine = line.trim();
                    if (trimmedLine.startsWith('?')) {
                        if (currentQuestion) questions.push(currentQuestion);
                        currentQuestion = { question: trimmedLine.substring(1).trim(), answers: [] };
                    } else if (currentQuestion) {
                        const isCorrect = currentQuestion.answers.length === 0;
                        currentQuestion.answers.push({ text: trimmedLine, correct: isCorrect });
                    }
                });
                if (currentQuestion) questions.push(currentQuestion);

                if (questions.length > 0) {
                    const taskData = {
                        taskId: `task_${Date.now()}`,
                        questions: questions,
                        createdAt: new Date().toISOString(),
                        expiresAt: expiry ? new Date(expiry).toISOString() : null,
                        teacherId: teacherId,
                    };
                    set(ref(db, `schools/${schoolId}/bonusTasks/${activeClassId}`), taskData)
                        .then(() => { closeModal(); showMessage('Bonus task started successfully!', 'Success'); })
                        .catch(err => showMessage(`Error: ${err.message}`, 'Error'));
                } else { showMessage('No valid questions found. Ensure questions start with "?".', 'Parsing Error'); }
            }

            if (target.id === 'btnSaveGtBank') {
                const text = $('#gtQuestionsImport').value.trim();
                const lines = text.split('\n').filter(line => line.trim() !== '');
                
                if (lines.length === 0) {
                    set(ref(db, `schools/${schoolId}/gtTraining/${teacherId}`), null)
                        .then(() => { closeModal(); showMessage('Your question bank has been cleared.', 'Success'); })
                        .catch(err => showMessage(`Error: ${err.message}`, 'Error'));
                    return;
                }

                const questions = [];
                let currentQuestion = null;

                lines.forEach(line => {
                    const trimmedLine = line.trim();
                    if (trimmedLine.startsWith('?')) {
                        if (currentQuestion) questions.push(currentQuestion);
                        currentQuestion = { question: trimmedLine.substring(1).trim(), answers: [] };
                    } else if (currentQuestion) {
                        const isCorrect = currentQuestion.answers.length === 0;
                        currentQuestion.answers.push({ text: trimmedLine, correct: isCorrect });
                    }
                });
                if (currentQuestion) questions.push(currentQuestion);

                if (questions.length > 100) {
                    return showMessage('You can upload a maximum of 100 questions.', 'Error');
                }

                if (questions.length > 0) {
                    const gtData = {
                        questions: questions,
                        subject: teacherProfile.subject || 'General Knowledge',
                        teacherId: teacherId,
                        updatedAt: new Date().toISOString(),
                    };
                    set(ref(db, `schools/${schoolId}/gtTraining/${teacherId}`), gtData)
                        .then(() => { closeModal(); showMessage('Question bank saved successfully!', 'Success'); })
                        .catch(err => showMessage(`Error: ${err.message}`, 'Error'));
                } else { showMessage('No valid questions found. Ensure questions start with "?".', 'Parsing Error'); }
            }

            const manageModal = $('#manageModal');
            if (manageModal.classList.contains('show') && $('#manageModalBody').contains(target)) {
                if (target.closest('[data-remove="item"]')) {
                    const powerEditor = target.closest('.power-item-editor');
                    if (powerEditor) {
                        powerEditor.remove();
                    } else {
                        target.closest('.form-grid').remove();
                    }
                }
                if (target.id === 'btnAddPower') { 
                    $('#powersList').insertAdjacentHTML('beforeend', `
                    <div class="power-item-editor">
                        <div class="form-grid" data-item-type="powers" style="margin-bottom: 8px;">
                            <input type="text" placeholder="🔮" data-field="emoji" style="text-align:center; font-size: 18px;">
                            <input type="text" placeholder="Power Name" data-field="name">
                            <input type="number" placeholder="Cost" value="100" data-field="cost">
                            <button class="btn small danger" data-remove="item">✖</button>
                        </div>
                        <textarea placeholder="Item description..." data-field="description" style="min-height: 60px; font-size: 13px; resize: none;"></textarea>
                    </div>`); 
                }
                if (target.id === 'btnQuickAction') { $('#actionsList').insertAdjacentHTML('beforeend', `<div class="form-grid" data-item-type="quickActions" style="grid-template-columns: 1fr 1fr 50px;"><input type="text" placeholder="Label" data-field="label"><input type="number" placeholder="Amount" data-field="delta"><button class="btn small danger" data-remove="item">✖</button></div>`); }
                
                if (target.id === 'btnSaveChanges') {
                    const type = target.dataset.type;
                    const data = [];
                    if (type === 'powers') {
                        document.querySelectorAll(`#manageModalBody .power-item-editor`).forEach(editor => {
                            const row = editor.querySelector('[data-item-type="powers"]');
                            const name = row.querySelector('[data-field="name"]').value.trim();
                            if (name) {
                                data.push({
                                    id: row.dataset.id || `power-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                                    emoji: row.querySelector('[data-field="emoji"]').value.trim(),
                                    name,
                                    cost: Number(row.querySelector('[data-field="cost"]').value) || 0,
                                    description: editor.querySelector('[data-field="description"]').value.trim()
                                });
                            }
                        });
                    } else if (type === 'quickActions') {
                        document.querySelectorAll(`#manageModalBody [data-item-type="quickActions"]`).forEach(row => {
                            const label = row.querySelector('[data-field="label"]').value.trim();
                            if (label) data.push({ label, delta: Number(row.querySelector('[data-field="delta"]').value) || 0 });
                        });
                    }
                    
                    target.disabled = true; target.textContent = 'Saving...';
                    const updates = {};
                    updates[`/teachers/${teacherId}/settings/${type}`] = data.length > 0 ? data : null;

                    update(ref(db, `schools/${schoolId}`), updates)
                        .then(() => { closeModal(); showMessage('Your settings have been saved successfully!', 'Success'); })
                        .catch(err => showMessage(`Error saving: ${err.message}`, 'Error'))
                        .finally(() => {
                            const saveBtn = document.querySelector('#btnSaveChanges');
                            if(saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'Save Changes'; }
                        });
                }
                
                if (target.id === 'btnSaveChangesPassword') {
                    const currentPassword = $('#currentPasswordInput').value;
                    const newPassword = $('#newPasswordInput').value;
                    const confirmPassword = $('#confirmPasswordInput').value;

                    if (!currentPassword) return showMessage("Please enter your current password.", "Error");
                    if (!newPassword || newPassword.length < 6) return showMessage("New password must be at least 6 characters long.", "Error");
                    if (newPassword !== confirmPassword) return showMessage("New passwords do not match.", "Error");
                    
                    target.disabled = true; target.textContent = "Verifying...";
                    const user = auth.currentUser;
                    const credential = EmailAuthProvider.credential(user.email, currentPassword);

                    reauthenticateWithCredential(user, credential).then(() => {
                        target.textContent = "Saving...";
                        return updatePassword(user, newPassword);
                    }).then(() => {
                        closeModal();
                        showMessage("Password updated successfully!", "Success");
                    }).catch((error) => {
                        console.error(error);
                        if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                            showMessage("The current password you entered is incorrect.", "Authentication Failed");
                        } else {
                            showMessage("An error occurred. If you recently changed your password, please log out and log back in before trying again.", "Error");
                        }
                    }).finally(() => {
                        target.disabled = false; target.textContent = "Save New Password";
                    });
                }

                const purchaseBtn = target.closest('[data-purchase-power-id]');
                if (purchaseBtn) {
                    const power = teacherProfile.settings.powers.find(p => p.id === purchaseBtn.dataset.purchasePowerId);
                    if (!power) return;
                    if (confirm(`Purchase "${power.name}" for ${power.cost} EDcoins for eligible selected students?`)) {
                        const updates = {};
                        let successCount = 0;
                        selectedStudentIds.forEach(sid => {
                            const student = schoolData.students[sid];
                            if (student && !(student.powers?.some(p => p.powerId === power.id)) && (student.edcoins || 0) >= power.cost) {
                                updates[`/students/${sid}/edcoins`] = student.edcoins - power.cost;
                                updates[`/students/${sid}/powers`] = [...(student.powers || []), { powerId: power.id, teacherId, purchasedAt: new Date().toISOString() }];
                                successCount++;
                            }
                        });
                        if (successCount > 0) {
                            update(ref(db, `schools/${schoolId}`), updates).then(() => { closeModal(); showMessage(`${successCount} student(s) received the item.`, 'Purchase Complete'); });
                        } else { showMessage("No selected students were eligible (not enough EDcoins or already own it).", "Purchase Failed"); }
                    }
                }
            }
        });
    </script>
</body>
</html>